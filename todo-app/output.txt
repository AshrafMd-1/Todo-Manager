
> todo-app@1.0.0 pretest
> NODE_ENV=test npx sequelize-cli db:drop && NODE_ENV=test npx sequelize-cli db:create


[4mSequelize CLI [Node: 19.7.0, CLI: 6.6.0, ORM: 6.29.0][24m

Loaded configuration file "config/config.json".
Using environment "test".
Database [94mtodo_db_test[39m dropped.

[4mSequelize CLI [Node: 19.7.0, CLI: 6.6.0, ORM: 6.29.0][24m

Loaded configuration file "config/config.json".
Using environment "test".
Database [94mtodo_db_test[39m created.

> todo-app@1.0.0 test
> NODE_ENV=test jest --detectOpenHandles

  console.log
    Executing (default): DROP TABLE IF EXISTS "Todos" CASCADE;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): SELECT DISTINCT tc.constraint_name as constraint_name, tc.constraint_schema as constraint_schema, tc.constraint_catalog as constraint_catalog, tc.table_name as table_name,tc.table_schema as table_schema,tc.table_catalog as table_catalog,tc.initially_deferred as initially_deferred,tc.is_deferrable as is_deferrable,kcu.column_name as column_name,ccu.table_schema  AS referenced_table_schema,ccu.table_catalog  AS referenced_table_catalog,ccu.table_name  AS referenced_table_name,ccu.column_name AS referenced_column_name FROM information_schema.table_constraints AS tc JOIN information_schema.key_column_usage AS kcu ON tc.constraint_name = kcu.constraint_name JOIN information_schema.constraint_column_usage AS ccu ON ccu.constraint_name = tc.constraint_name WHERE constraint_type = 'FOREIGN KEY' AND tc.table_name = 'Todos' AND tc.table_catalog = 'todo_db_test'

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): DROP TABLE IF EXISTS "Todos" CASCADE;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): DROP TABLE IF EXISTS "Todos" CASCADE;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): CREATE TABLE IF NOT EXISTS "Todos" ("id"   SERIAL , "title" VARCHAR(255), "dueDate" DATE, "completed" BOOLEAN, "createdAt" TIMESTAMP WITH TIME ZONE NOT NULL, "updatedAt" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id"));

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): SELECT i.relname AS name, ix.indisprimary AS primary, ix.indisunique AS unique, ix.indkey AS indkey, array_agg(a.attnum) as column_indexes, array_agg(a.attname) AS column_names, pg_get_indexdef(ix.indexrelid) AS definition FROM pg_class t, pg_class i, pg_index ix, pg_attribute a WHERE t.oid = ix.indrelid AND i.oid = ix.indexrelid AND a.attrelid = t.oid AND t.relkind = 'r' and t.relname = 'Todos' GROUP BY i.relname, ix.indexrelid, ix.indisprimary, ix.indisunique, ix.indkey ORDER BY i.relname;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Processing list of all Todos ...

      at log (app.js:20:11)

  console.warn
    Deprecation warning: value provided is not in a recognized RFC2822 or ISO format. moment construction falls back to js Date(), which is not reliable across all browsers and versions. Non RFC2822/ISO date formats are discouraged. Please refer to http://momentjs.com/guides/#/warnings/js-date/ for more info.
    Arguments: 
    [0] _isAMomentObject: true, _isUTC: false, _useUTC: false, _l: undefined, _i: 3/11/2023, _f: undefined, _strict: undefined, _locale: [object Object]
    Error: 
        at Function.createFromInputFallback (/home/ashraf/web_development/wd201/todo-app/node_modules/moment/moment.js:324:25)
        at configFromString (/home/ashraf/web_development/wd201/todo-app/node_modules/moment/moment.js:2550:19)
        at configFromInput (/home/ashraf/web_development/wd201/todo-app/node_modules/moment/moment.js:2993:13)
        at prepareConfig (/home/ashraf/web_development/wd201/todo-app/node_modules/moment/moment.js:2976:13)
        at createFromConfig (/home/ashraf/web_development/wd201/todo-app/node_modules/moment/moment.js:2943:44)
        at createLocalOrUTC (/home/ashraf/web_development/wd201/todo-app/node_modules/moment/moment.js:3037:16)
        at createLocal (/home/ashraf/web_development/wd201/todo-app/node_modules/moment/moment.js:3041:16)
        at hooks (/home/ashraf/web_development/wd201/todo-app/node_modules/moment/moment.js:16:29)
        at DATEONLY._stringify (/home/ashraf/web_development/wd201/todo-app/node_modules/sequelize/src/data-types.js:488:12)
        at DATEONLY._stringify (/home/ashraf/web_development/wd201/todo-app/node_modules/sequelize/src/dialects/postgres/data-types.js:52:20)
        at DATEONLY.stringify (/home/ashraf/web_development/wd201/todo-app/node_modules/sequelize/src/data-types.js:24:19)
        at PostgresQueryGenerator.escape (/home/ashraf/web_development/wd201/todo-app/node_modules/sequelize/src/dialects/abstract/query-generator.js:1065:30)
        at PostgresQueryGenerator._whereParseSingleValueObject (/home/ashraf/web_development/wd201/todo-app/node_modules/sequelize/src/dialects/abstract/query-generator.js:2775:41)
        at PostgresQueryGenerator.whereItemQuery (/home/ashraf/web_development/wd201/todo-app/node_modules/sequelize/src/dialects/abstract/query-generator.js:2475:21)
        at /home/ashraf/web_development/wd201/todo-app/node_modules/sequelize/src/dialects/abstract/query-generator.js:2376:25
        at Array.forEach (<anonymous>)
        at PostgresQueryGenerator.whereItemsQuery (/home/ashraf/web_development/wd201/todo-app/node_modules/sequelize/src/dialects/abstract/query-generator.js:2374:35)
        at PostgresQueryGenerator.getWhereConditions (/home/ashraf/web_development/wd201/todo-app/node_modules/sequelize/src/dialects/abstract/query-generator.js:2802:19)
        at PostgresQueryGenerator.selectQuery (/home/ashraf/web_development/wd201/todo-app/node_modules/sequelize/src/dialects/abstract/query-generator.js:1412:28)
        at PostgresQueryInterface.select (/home/ashraf/web_development/wd201/todo-app/node_modules/sequelize/src/dialects/abstract/query-interface.js:1002:27)
        at Function.findAll (/home/ashraf/web_development/wd201/todo-app/node_modules/sequelize/src/model.js:1816:47)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at /home/ashraf/web_development/wd201/todo-app/app.js:22:21

      20 |   console.log("Processing list of all Todos ...");
      21 |   try {
    > 22 |     const overdue = await Todo.overdueTodos();
         |                     ^
      23 |     const today = await Todo.todayTodos();
      24 |     const later = await Todo.laterTodos();
      25 |     const completed = await Todo.completedTodos();

      at warn (node_modules/moment/moment.js:287:21)
      at Function.createFromInputFallback (node_modules/moment/moment.js:319:17)
      at configFromString (node_modules/moment/moment.js:2550:19)
      at configFromInput (node_modules/moment/moment.js:2993:13)
      at prepareConfig (node_modules/moment/moment.js:2976:13)
      at createFromConfig (node_modules/moment/moment.js:2943:44)
      at createLocalOrUTC (node_modules/moment/moment.js:3037:16)
      at createLocal (node_modules/moment/moment.js:3041:16)
      at hooks (node_modules/moment/moment.js:16:29)
      at DATEONLY._stringify (node_modules/sequelize/src/data-types.js:488:12)
      at DATEONLY._stringify (node_modules/sequelize/src/dialects/postgres/data-types.js:52:20)
      at DATEONLY.stringify (node_modules/sequelize/src/data-types.js:24:19)
      at PostgresQueryGenerator.escape (node_modules/sequelize/src/dialects/abstract/query-generator.js:1065:30)
      at PostgresQueryGenerator._whereParseSingleValueObject (node_modules/sequelize/src/dialects/abstract/query-generator.js:2775:41)
      at PostgresQueryGenerator.whereItemQuery (node_modules/sequelize/src/dialects/abstract/query-generator.js:2475:21)
      at node_modules/sequelize/src/dialects/abstract/query-generator.js:2376:25
          at Array.forEach (<anonymous>)
      at PostgresQueryGenerator.whereItemsQuery (node_modules/sequelize/src/dialects/abstract/query-generator.js:2374:35)
      at PostgresQueryGenerator.getWhereConditions (node_modules/sequelize/src/dialects/abstract/query-generator.js:2802:19)
      at PostgresQueryGenerator.selectQuery (node_modules/sequelize/src/dialects/abstract/query-generator.js:1412:28)
      at PostgresQueryInterface.select (node_modules/sequelize/src/dialects/abstract/query-interface.js:1002:27)
      at Function.findAll (node_modules/sequelize/src/model.js:1816:47)
      at app.js:22:21

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."dueDate" < '2023-03-11' AND "Todo"."completed" = false;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."dueDate" = '2023-03-11' AND "Todo"."completed" = false;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."dueDate" > '2023-03-11' AND "Todo"."completed" = false;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."completed" = true;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Processing a new Todo with title:  Buy milk

      at log (app.js:55:11)

  console.log
    Executing (default): INSERT INTO "Todos" ("id","title","dueDate","completed","createdAt","updatedAt") VALUES (DEFAULT,$1,$2,$3,$4,$5) RETURNING "id","title","dueDate","completed","createdAt","updatedAt";

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Processing list of all Todos ...

      at log (app.js:20:11)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."dueDate" < '2023-03-11' AND "Todo"."completed" = false;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."dueDate" = '2023-03-11' AND "Todo"."completed" = false;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."dueDate" > '2023-03-11' AND "Todo"."completed" = false;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."completed" = true;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Processing list of all Todos ...

      at log (app.js:20:11)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."dueDate" < '2023-03-11' AND "Todo"."completed" = false;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."dueDate" = '2023-03-11' AND "Todo"."completed" = false;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."dueDate" > '2023-03-11' AND "Todo"."completed" = false;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."completed" = true;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    <!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="utf-8">
    <title>Error</title>
    </head>
    <body>
    <pre>Error: Did not get a valid CSRF token for &#39;PUT /todos/1&#39;: ed8a7d4f-4cb1-43c4-aedb-58d719d808ad v. 7b03f0fb783e6a36613579e2a2cbe357:14c9b9fd428a5a11aa7cd84cda2e0a0e4a327b8d8ca42c0c23418b9abdc267afb7352aa7e98bf50212f7a3ed87335af5<br> &nbsp; &nbsp;at /home/ashraf/web_development/wd201/todo-app/node_modules/tiny-csrf/index.js:51:15<br> &nbsp; &nbsp;at Layer.handle [as handle_request] (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/layer.js:95:5)<br> &nbsp; &nbsp;at trim_prefix (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:328:13)<br> &nbsp; &nbsp;at /home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:286:9<br> &nbsp; &nbsp;at Function.process_params (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:346:12)<br> &nbsp; &nbsp;at next (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:280:10)<br> &nbsp; &nbsp;at cookieParser (/home/ashraf/web_development/wd201/todo-app/node_modules/cookie-parser/index.js:71:5)<br> &nbsp; &nbsp;at Layer.handle [as handle_request] (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/layer.js:95:5)<br> &nbsp; &nbsp;at trim_prefix (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:328:13)<br> &nbsp; &nbsp;at /home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:286:9<br> &nbsp; &nbsp;at Function.process_params (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:346:12)<br> &nbsp; &nbsp;at next (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:280:10)<br> &nbsp; &nbsp;at serveStatic (/home/ashraf/web_development/wd201/todo-app/node_modules/serve-static/index.js:75:16)<br> &nbsp; &nbsp;at Layer.handle [as handle_request] (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/layer.js:95:5)<br> &nbsp; &nbsp;at trim_prefix (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:328:13)<br> &nbsp; &nbsp;at /home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:286:9<br> &nbsp; &nbsp;at Function.process_params (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:346:12)<br> &nbsp; &nbsp;at next (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:280:10)<br> &nbsp; &nbsp;at urlencodedParser (/home/ashraf/web_development/wd201/todo-app/node_modules/body-parser/lib/types/urlencoded.js:82:7)<br> &nbsp; &nbsp;at Layer.handle [as handle_request] (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/layer.js:95:5)<br> &nbsp; &nbsp;at trim_prefix (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:328:13)<br> &nbsp; &nbsp;at /home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:286:9<br> &nbsp; &nbsp;at Function.process_params (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:346:12)<br> &nbsp; &nbsp;at next (/home/ashraf/web_development/wd201/todo-app/node_modules/express/lib/router/index.js:280:10)<br> &nbsp; &nbsp;at /home/ashraf/web_development/wd201/todo-app/node_modules/body-parser/lib/read.js:137:5<br> &nbsp; &nbsp;at AsyncResource.runInAsyncScope (node:async_hooks:203:9)<br> &nbsp; &nbsp;at invokeCallback (/home/ashraf/web_development/wd201/todo-app/node_modules/raw-body/index.js:238:16)<br> &nbsp; &nbsp;at done (/home/ashraf/web_development/wd201/todo-app/node_modules/raw-body/index.js:227:7)<br> &nbsp; &nbsp;at IncomingMessage.onEnd (/home/ashraf/web_development/wd201/todo-app/node_modules/raw-body/index.js:287:7)<br> &nbsp; &nbsp;at IncomingMessage.emit (node:events:512:28)<br> &nbsp; &nbsp;at endReadableNT (node:internal/streams/readable:1359:12)<br> &nbsp; &nbsp;at processTicksAndRejections (node:internal/process/task_queues:82:21)</pre>
    </body>
    </html>

      at Object.log (__tests__/todos.js:62:17)

  console.log
    Processing list of all Todos ...

      at log (app.js:20:11)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."dueDate" < '2023-03-11' AND "Todo"."completed" = false;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."dueDate" = '2023-03-11' AND "Todo"."completed" = false;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."dueDate" > '2023-03-11' AND "Todo"."completed" = false;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    Executing (default): SELECT "id", "title", "dueDate", "completed", "createdAt", "updatedAt" FROM "Todos" AS "Todo" WHERE "Todo"."completed" = true;

      at Sequelize.log (node_modules/sequelize/src/sequelize.js:1280:15)

  console.log
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <link href="./css/styles.css" rel="stylesheet">
        <meta name="csrf-token" content="a178c48d-a674-4ad3-9e98-8a2eb31db1fe">
        <title>Todo-List</title>
    
        <script>
            const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            const updateTodo = (id) => {
                const checkSelected = document.getElementById(`${id}`).checked;
                fetch(`/todos/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        completed: checkSelected,
                        "_csrf": token
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    },
                }).then((res) => {
                    if (res.ok) {
                        window.location.reload();
                    }
                }).catch((err) => {
                    console.log(err);
                });
            };
    
            const deleteTodo = (id) => {
                const token=document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                fetch(`/todos/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "_csrf": token
                    })
                }).then((res) => {
                    if (res.ok) {
                        window.location.reload();
                    }
                }).catch((err) => {
                    console.log(err);
                });
            };
        </script>
    
    </head>
    <body>
    <header>
        <h1>This is my Todo Application</h1>
    </header>
    <main>
        <p class="title">Type your TODO here</p>
        <div class="page">
            <form class="input-form" action="/todos" method="post">
                <input type="hidden" name="_csrf" value="a178c48d-a674-4ad3-9e98-8a2eb31db1fe">
                <div class="todo">
                    <label for="todo">Todo</label>
                    <input name="title" id="todo" placeholder="Type Your Task..." required type="text">
                </div>
                <div class="date">
                    <label for="date">Date</label>
                    <input name="dueDate" id="date" required type="date">
                </div>
                <div class="add">
                    <button id="add" type="submit">Add</button>
                </div>
            </form>
            <div class="tasks">
                <div class="overdue">
        <div class="todo-header">
            <h5>Overdue</h5>
            <span class="todo-count" id="count-overdue">
                    [0]
                </span>
        </div>
        <div id="overdue">
            
        </div>
    </div>
                <div class="today">
        <div class="todo-header">
            <h5>Due Today</h5>
            <span class="todo-count" id="count-today">
                    [1]
                </span>
        </div>
        <div id="today">
            
            <div class="todo-item">
                <input onclick="updateTodo( 1)" type="checkbox" id="1"  />
                <label for="1">Buy milk</label>
                <button onclick="deleteTodo(1)" class="delete-todo">X</button>
            </div>
            
        </div>
    </div>
                <div class="upcoming">
        <div class="todo-header">
            <h5>Due Later</h5>
            <span class="todo-count" id="count-upcoming">
                    [0]
                </span>
        </div>
        <div id="upcoming">
            
        </div>
    </div>
                <div class="completed">
        <div class="todo-header">
            <h5>Completed Items</h5>
            <span class="todo-count" id="count-completed">
                    [0]
                </span>
        </div>
        <div id="completed">
            
        </div>
    </div>
            </div>
        </div>
    </main>
    <footer>
        <h1>Built with Node.js</h1>
    </footer>
    </body>
    </html>

      at Object.log (__tests__/todos.js:65:17)

